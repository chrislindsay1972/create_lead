void automation.lead_gen(String sector,String company_size,String jobTitle)
{
out = Map();
// End-to-end: discover UK companies for a sector + size (up to 20, paginated),
// then enrich each company with TWO contacts (primary + secondary) and email pattern info.
// 
// EMAIL GENERATION + VALIDATION via MULTI-SIGNAL approach:
// 
// When Perplexity doesn't find an email, we GENERATE probable emails:
// - Parse contact name into first/last (handles "Sarah O'Toole" -> sarah, otoole)
// - Generate 5 patterns: firstname.lastname, f.lastname, firstname, firstnamelastname, flastname
// - Validate via Perplexity web search to find best match
//
// Validation signals:
// - Syntax validation
// - MX record check (domain has mail servers)
// - Email pattern analysis (firstname.lastname etc)
// - Name-to-email matching
// - LinkedIn/Web search validation (person exists at company)
//
// Constraints respected:
// - NO while
// - NO ternary
// - NO replace()
// - NO split()   <-- IMPORTANT (uses indexOf/subString only)
//
// Usage example:
// result = automation.lead_gen("finance","100","CFO");
// -----------------------------------------
// API config
// -----------------------------------------
PERPLEXITY_API_KEY = zoho.crm.getOrgVariable("PERPLEXITY_API_KEY");

api_key_valid = false;
if(PERPLEXITY_API_KEY != null && PERPLEXITY_API_KEY.trim() != "")
{
	api_key_valid = true;
}
if(api_key_valid == false)
{
	out.put("status","ERROR");
	out.put("message","PERPLEXITY_API_KEY not configured. Please set the org variable.");
	info out;
}
if(api_key_valid == true)
{
// Use sonar model for web search capability
MODEL = "sonar";
headers = Map();
headers.put("Authorization","Bearer " + PERPLEXITY_API_KEY);
headers.put("Content-Type","application/json");

// -----------------------------------------
// Inputs / defaults
// -----------------------------------------
requested_sector = "";
if(sector != null)
{
	requested_sector = sector.trim().toLowerCase();
}
requested_size = "";
if(company_size != null)
{
	requested_size = company_size.trim();
}
target_job_title = "";
if(jobTitle != null)
{
	target_job_title = jobTitle.trim();
}
// -----------------------------------------
// Helper: parse company_size into a normalised filter (NO split)
// -----------------------------------------
size_filter_type = "unknown";
size_single = 0;
size_lower = 0;
size_upper = 0;
size_min = 0;
if(requested_size != "")
{
	if(requested_size.contains("-"))
	{
		dashPos = requested_size.indexOf("-");
		if(dashPos > 0 && dashPos < requested_size.length() - 1)
		{
			try 
			{
				leftPart = requested_size.subString(0,dashPos).trim();
				rightPart = requested_size.subString(dashPos + 1,requested_size.length()).trim();
				size_lower = leftPart.toLong();
				size_upper = rightPart.toLong();
				size_filter_type = "range";
			}
			catch (e_size_range)
			{
				size_filter_type = "unknown";
			}
		}
	}
	else if(requested_size.endsWith("+"))
	{
		try 
		{
			min_str = requested_size.subString(0,requested_size.length() - 1).trim();
			size_min = min_str.toLong();
			size_filter_type = "min";
		}
		catch (e_size_min)
		{
			size_filter_type = "unknown";
		}
	}
	else
	{
		try 
		{
			size_single = requested_size.toLong();
			size_filter_type = "single";
		}
		catch (e_size_single)
		{
			size_filter_type = "unknown";
		}
	}
}
// -----------------------------------------
// Pagination controls
// -----------------------------------------
max_companies = 20;
page_size = 10;
pages_seed = List();
pages_seed.add(1);
pages_seed.add(2);
pages_seed.add(3);
next_page_token = null;
companies_found = List();
// -----------------------------------------
// CALL A: Company discovery pages (UK)
// -----------------------------------------
for each  page in pages_seed
{
	if(companies_found.size() >= max_companies)
	{
		break;
	}
	if(page != 1)
	{
		if(next_page_token == null || (next_page_token + "").trim() == "")
		{
			break;
		}
	}
	token_str = "null";
	if(next_page_token != null && (next_page_token + "").trim() != "")
	{
		token_str = next_page_token;
	}
	promptA = "Search the web and find UK companies in the " + requested_sector + " sector with approximately " + requested_size + " employees.\n\n" + "Page: " + page + " of results (return " + page_size + " companies per page).\n\n" + "For each company, search for and provide:\n" + "1. Company name\n" + "2. Official website URL\n" + "3. Employee size range (e.g., '1-10', '11-50', '51-200', '201-500', '501-1000', '1000+')\n" + "4. Location (city, UK)\n" + "5. Specific sector/industry\n\n" + "Return ONLY a valid JSON object with no markdown formatting, no code blocks, no explanation.\n" + "The response must start with { and end with }\n\n" + "JSON schema:\n" + "{\n" + "  \"companies\": [\n" + "    {\"name\": \"Company Name\", \"website\": \"https://example.com\", \"employee_size\": \"51-200\", \"location\": \"London, UK\", \"sector\": \"Finance\", \"source_url\": \"https://source.com\"}\n" + "  ],\n" + "  \"next_page_token\": \"page2\" \n" + "}\n\n" + "Set next_page_token to null if no more results exist.";
	input_items_A = List();
	user_item_A = Map();
	user_item_A.put("role","user");
	user_item_A.put("content",promptA);
	input_items_A.add(user_item_A);
	body_A = Map();
	body_A.put("model",MODEL);
	body_A.put("messages",input_items_A);
	body_A.put("temperature",0);
	respA = null;
	rawA = null;
	try 
	{
		respA = invokeurl
		[
			url :"https://api.perplexity.ai/chat/completions"
			type :POST
			body:body_A.toString()
			headers:headers
		];
	}
	catch (e_callA)
	{
		info "Discovery API call failed: " + e_callA;
		continue;
	}
	try 
	{
		if(respA != null && respA.containsKey("choices"))
		{
			choices_A = respA.get("choices");
			if(choices_A != null && choices_A.size() > 0)
			{
				first_choice_A = choices_A.get(0);
				if(first_choice_A != null && first_choice_A.containsKey("message"))
				{
					message_A = first_choice_A.get("message");
					if(message_A != null && message_A.containsKey("content"))
					{
						rawA = message_A.get("content");
					}
				}
			}
		}
	}
	catch (eA_extract)
	{
		rawA = null;
	}
	if(rawA == null || rawA.trim() == "")
	{
		continue;
	}
	jsonA = rawA;
	try 
	{
		sA = rawA.indexOf("{");
		eA = rawA.lastIndexOf("}");
		if(sA >= 0 && eA > sA)
		{
			jsonA = rawA.subString(sA,eA + 1);
		}
	}
	catch (eA_slice)
	{
		jsonA = rawA;
	}
	disc_map = null;
	try 
	{
		disc_map = jsonA.toMap();
	}
	catch (eA_parse)
	{
		info "Failed to parse discovery JSON: " + jsonA;
		continue;
	}
	page_companies = disc_map.get("companies");
	if(page_companies == null)
	{
		page_companies = List();
	}
	next_page_token = disc_map.get("next_page_token");
	for each  c in page_companies
	{
		if(c == null)
		{
			continue;
		}
		if(companies_found.size() >= max_companies)
		{
			break;
		}
		w = c.get("website");
		if(w == null || (w + "").trim() == "")
		{
			continue;
		}
		wlc = (w + "").trim().toLowerCase();
		if(wlc.startsWith("https://"))
		{
			wlc = wlc.subString(8,wlc.length());
		}
		else if(wlc.startsWith("http://"))
		{
			wlc = wlc.subString(7,wlc.length());
		}
		if(wlc.endsWith("/"))
		{
			wlc = wlc.subString(0,wlc.length() - 1);
		}
		already = false;
		for each  existing in companies_found
		{
			if(existing != null && existing.get("website") != null)
			{
				exw = (existing.get("website") + "").trim().toLowerCase();
				if(exw.startsWith("https://"))
				{
					exw = exw.subString(8,exw.length());
				}
				else if(exw.startsWith("http://"))
				{
					exw = exw.subString(7,exw.length());
				}
				if(exw.endsWith("/"))
				{
					exw = exw.subString(0,exw.length() - 1);
				}
				if(exw == wlc)
				{
					already = true;
					break;
				}
			}
		}
		if(already == false)
		{
			companies_found.add(c);
		}
	}
}
// -----------------------------------------
// Filter companies by size + sector
// -----------------------------------------
matching_companies = List();
for each  comp in companies_found
{
	if(comp == null)
	{
		continue;
	}
	comp_sector = "";
	if(comp.get("sector") != null)
	{
		comp_sector = (comp.get("sector") + "").trim().toLowerCase();
	}
	comp_size = "";
	if(comp.get("employee_size") != null)
	{
		comp_size = (comp.get("employee_size") + "").trim();
	}
	sector_match = false;
	if(requested_sector == "")
	{
		sector_match = true;
	}
	else
	{
		if(comp_sector != "" && (comp_sector.indexOf(requested_sector) >= 0 || requested_sector.indexOf(comp_sector) >= 0))
		{
			sector_match = true;
		}
		if(sector_match == false && requested_sector == "finance")
		{
			if(comp_sector == "fintech" || comp_sector == "accounting" || comp_sector == "professional services")
			{
				sector_match = true;
			}
		}
	}
	size_match = false;
	if(requested_size == "" || size_filter_type == "unknown")
	{
		size_match = true;
	}
	else
	{
		comp_low = 0;
		comp_high = 0;
		if(comp_size != "")
		{
			if(comp_size.contains("-"))
			{
				d2 = comp_size.indexOf("-");
				if(d2 > 0 && d2 < comp_size.length() - 1)
				{
					try 
					{
						cl = comp_size.subString(0,d2).trim().toLong();
						ch = comp_size.subString(d2 + 1,comp_size.length()).trim().toLong();
						comp_low = cl;
						comp_high = ch;
					}
					catch (e_cs1)
					{
						comp_low = 0;
						comp_high = 0;
					}
				}
			}
			else if(comp_size.endsWith("+"))
			{
				try 
				{
					cmin = comp_size.subString(0,comp_size.length() - 1).trim().toLong();
					comp_low = cmin;
					comp_high = 999999;
				}
				catch (e_cs2)
				{
					comp_low = 0;
					comp_high = 999999;
				}
			}
		}
		if(size_filter_type == "single")
		{
			if(comp_high > 0 && size_single >= comp_low && size_single <= comp_high)
			{
				size_match = true;
			}
		}
		else if(size_filter_type == "range")
		{
			if(comp_high > 0)
			{
				if(!(comp_high < size_lower || comp_low > size_upper))
				{
					size_match = true;
				}
			}
		}
		else if(size_filter_type == "min")
		{
			if(comp_high > 0 && comp_high >= size_min)
			{
				size_match = true;
			}
		}
	}
	if(sector_match && size_match)
	{
		matching_companies.add(comp);
	}
	if(matching_companies.size() >= max_companies)
	{
		break;
	}
}
// -----------------------------------------
// Enrich each company with contacts + MULTI-SIGNAL EMAIL VALIDATION
// -----------------------------------------
results = List();
for each  comp2 in matching_companies
{
	website = null;
	if(comp2.get("website") != null)
	{
		website = (comp2.get("website") + "").trim();
	}
	if(website == null || website == "")
	{
		continue;
	}
	company_name = null;
	if(comp2.get("name") != null)
	{
		company_name = (comp2.get("name") + "").trim();
	}
	domain_lc = website.trim().toLowerCase();
	if(domain_lc.startsWith("https://"))
	{
		domain_lc = domain_lc.subString(8,domain_lc.length());
	}
	else if(domain_lc.startsWith("http://"))
	{
		domain_lc = domain_lc.subString(7,domain_lc.length());
	}
	slash_index = domain_lc.indexOf("/");
	if(slash_index > 0)
	{
		domain_lc = domain_lc.subString(0,slash_index);
	}
	colon_index = domain_lc.indexOf(":");
	if(colon_index > 0)
	{
		domain_lc = domain_lc.subString(0,colon_index);
	}
	if(domain_lc.startsWith("www."))
	{
		domain_lc = domain_lc.subString(4,domain_lc.length());
	}
	domain = domain_lc;
	
	company_name_str = "Unknown Company";
	if(company_name != null && company_name.trim() != "")
	{
		company_name_str = company_name;
	}
	prompt1 = "Search the web to find contact information for people at " + company_name_str + " (website: " + website + ").\n\n" + "I need to find:\n" + "1. PRIMARY CONTACT: Someone with the job title '" + target_job_title + "' or similar senior role\n" + "2. SECONDARY CONTACT: Another senior executive or decision maker\n\n" + "For each person, search LinkedIn, the company website, news articles, and business directories to find:\n" + "- Full name\n" + "- Job title\n" + "- Email address (look for patterns like firstname@" + domain + " or check company contact pages)\n" + "- Phone number\n" + "- LinkedIn profile URL\n" + "- Location\n\n" + "Also determine the company's email pattern (e.g., firstname@domain, firstname.lastname@domain, f.lastname@domain).\n\n" + "Return ONLY a valid JSON object with no markdown, no code blocks, no explanation.\n" + "The response must start with { and end with }\n\n" + "JSON schema:\n" + "{\n" + "  \"primary_stakeholder\": {\"name\": \"John Smith\", \"job_title\": \"CFO\", \"company\": \"" + company_name_str + "\", \"email\": \"john.smith@" + domain + "\", \"phone\": \"+44 123 456 7890\", \"location\": \"London, UK\", \"linkedin_url\": \"https://linkedin.com/in/johnsmith\", \"company_website\": \"" + website + "\", \"source_url\": \"https://where-you-found-this.com\", \"notes\": \"Found on company about page\"},\n" + "  \"secondary_stakeholder\": {\"name\": \"Jane Doe\", \"job_title\": \"CEO\", \"company\": \"" + company_name_str + "\", \"email\": \"jane.doe@" + domain + "\", \"phone\": null, \"location\": \"London, UK\", \"linkedin_url\": \"https://linkedin.com/in/janedoe\", \"company_website\": \"" + website + "\", \"source_url\": \"https://linkedin.com\", \"notes\": \"Found on LinkedIn\"},\n" + "  \"email_pattern_hint\": \"firstname.lastname@" + domain + "\",\n" + "  \"email_examples\": [\"john.smith@" + domain + "\", \"jane.doe@" + domain + "\"]\n" + "}\n\n" + "Use null for any field where information cannot be found. Always include source_url for verified information.";
	input_items_1 = List();
	user_item_1 = Map();
	user_item_1.put("role","user");
	user_item_1.put("content",prompt1);
	input_items_1.add(user_item_1);
	body_1 = Map();
	body_1.put("model",MODEL);
	body_1.put("messages",input_items_1);
	body_1.put("temperature",0);
	resp1 = null;
	raw1 = null;
	try 
	{
		resp1 = invokeurl
		[
			url :"https://api.perplexity.ai/chat/completions"
			type :POST
			body:body_1.toString()
			headers:headers
		];
	}
	catch (e_call1)
	{
		info "Contact discovery API call failed for " + company_name_str + ": " + e_call1;
		continue;
	}
	try 
	{
		if(resp1 != null && resp1.containsKey("choices"))
		{
			choices_1 = resp1.get("choices");
			if(choices_1 != null && choices_1.size() > 0)
			{
				first_choice_1 = choices_1.get(0);
				if(first_choice_1 != null && first_choice_1.containsKey("message"))
				{
					message_1 = first_choice_1.get("message");
					if(message_1 != null && message_1.containsKey("content"))
					{
						raw1 = message_1.get("content");
					}
				}
			}
		}
	}
	catch (e_text1)
	{
		raw1 = null;
	}
	if(raw1 == null || raw1.trim() == "")
	{
		continue;
	}
	json1 = raw1;
	try 
	{
		s1 = raw1.indexOf("{");
		e1 = raw1.lastIndexOf("}");
		if(s1 >= 0 && e1 > s1)
		{
			json1 = raw1.subString(s1,e1 + 1);
		}
	}
	catch (e_slice1)
	{
		json1 = raw1;
	}
	contact_map = null;
	try 
	{
		contact_map = json1.toMap();
	}
	catch (e_parse1)
	{
		info "Failed to parse contact JSON for " + company_name_str + ": " + json1;
		continue;
	}
	
	// Collect known emails from this company for pattern matching
	known_emails = List();
	if(contact_map.containsKey("email_examples"))
	{
		examples = contact_map.get("email_examples");
		if(examples != null)
		{
			for each ex in examples
			{
				if(ex != null && (ex + "").trim() != "")
				{
					known_emails.add(ex + "");
				}
			}
		}
	}
	
	primary_contact = Map();
	secondary_contact = Map();
	email_pattern = null;
	
	// Extract primary stakeholder
	if(contact_map.containsKey("primary_stakeholder"))
	{
		ps = contact_map.get("primary_stakeholder");
		if(ps != null)
		{
			primary_contact.put("name",ps.get("name"));
			primary_contact.put("job_title",ps.get("job_title"));
			primary_contact.put("company",ps.get("company"));
			primary_contact.put("email",ps.get("email"));
			primary_contact.put("phone",ps.get("phone"));
			primary_contact.put("location",ps.get("location"));
			primary_contact.put("linkedin_url",ps.get("linkedin_url"));
			primary_contact.put("company_website",ps.get("company_website"));
			primary_contact.put("source_url",ps.get("source_url"));
			primary_contact.put("notes",ps.get("notes"));
			
			// ========== EMAIL GENERATION + VALIDATION FOR PRIMARY ==========
			primary_email = ps.get("email");
			pv_name = ps.get("name");
			pv_title = ps.get("job_title");
			
			// If no email found but we have a name, GENERATE probable emails
			if((primary_email == null || (primary_email + "").trim() == "" || (primary_email + "").trim() == "null") && pv_name != null && (pv_name + "").trim() != "" && (pv_name + "").trim() != "null")
			{
				// Parse name into first and last (handle "Sarah O'Toole", "Lucy Smith", etc.)
				gen_full_name = (pv_name + "").trim().toLowerCase();
				gen_first = "";
				gen_last = "";
				
				// Find the space separating first and last name
				gen_space_pos = gen_full_name.indexOf(" ");
				if(gen_space_pos > 0)
				{
					gen_first = gen_full_name.subString(0, gen_space_pos);
					gen_last = gen_full_name.subString(gen_space_pos + 1, gen_full_name.length());
					
					// Handle multiple spaces (take last word as last name)
					gen_last_space = gen_last.lastIndexOf(" ");
					if(gen_last_space > 0)
					{
						gen_last = gen_last.subString(gen_last_space + 1, gen_last.length());
					}
				}
				
				// Clean names - remove apostrophes, hyphens for email (O'Toole -> otoole)
				gen_first_clean = "";
				for each char_idx in gen_first.length().range(0, gen_first.length())
				{
					gen_char = gen_first.subString(char_idx, char_idx + 1);
					if(gen_char != "'" && gen_char != "-" && gen_char != " ")
					{
						gen_first_clean = gen_first_clean + gen_char;
					}
				}
				
				gen_last_clean = "";
				for each char_idx2 in gen_last.length().range(0, gen_last.length())
				{
					gen_char2 = gen_last.subString(char_idx2, char_idx2 + 1);
					if(gen_char2 != "'" && gen_char2 != "-" && gen_char2 != " ")
					{
						gen_last_clean = gen_last_clean + gen_char2;
					}
				}
				
				// Generate email patterns if we have both names
				if(gen_first_clean != "" && gen_last_clean != "")
				{
					gen_emails = List();
					gen_emails.add(gen_first_clean + "." + gen_last_clean + "@" + domain);  // firstname.lastname
					gen_emails.add(gen_first_clean.subString(0, 1) + "." + gen_last_clean + "@" + domain);  // f.lastname
					gen_emails.add(gen_first_clean + "@" + domain);  // firstname
					gen_emails.add(gen_first_clean + gen_last_clean + "@" + domain);  // firstnamelastname
					gen_emails.add(gen_first_clean.subString(0, 1) + gen_last_clean + "@" + domain);  // flastname
					
					// Check MX records once for the domain
					gen_mx_found = false;
					gen_dns_url = "https://dns.google/resolve?name=" + domain + "&type=MX";
					try
					{
						gen_dns_resp = invokeurl
						[
							url: gen_dns_url
							type: GET
						];
						if(gen_dns_resp != null && gen_dns_resp.containsKey("Answer"))
						{
							gen_answers = gen_dns_resp.get("Answer");
							if(gen_answers != null && gen_answers.size() > 0)
							{
								gen_mx_found = true;
							}
						}
					}
					catch(gen_e_dns)
					{
						// DNS lookup failed
					}
					
					// Only proceed if domain has MX records
					if(gen_mx_found == true)
					{
						// Validate generated emails using Perplexity web search
						gen_prompt = "Search the web to find the email address for:\n\n";
						gen_prompt = gen_prompt + "Name: " + pv_name + "\n";
						gen_prompt = gen_prompt + "Company: " + company_name_str + "\n";
						gen_prompt = gen_prompt + "Domain: " + domain + "\n";
						if(pv_title != null && (pv_title + "").trim() != "")
						{
							gen_prompt = gen_prompt + "Job Title: " + pv_title + "\n";
						}
						gen_prompt = gen_prompt + "\nI have generated these possible email addresses:\n";
						gen_prompt = gen_prompt + "1. " + gen_emails.get(0) + "\n";
						gen_prompt = gen_prompt + "2. " + gen_emails.get(1) + "\n";
						gen_prompt = gen_prompt + "3. " + gen_emails.get(2) + "\n";
						gen_prompt = gen_prompt + "4. " + gen_emails.get(3) + "\n";
						gen_prompt = gen_prompt + "5. " + gen_emails.get(4) + "\n";
						gen_prompt = gen_prompt + "\nPlease search to determine:\n";
						gen_prompt = gen_prompt + "1. Does this person exist at this company? (LinkedIn, company website)\n";
						gen_prompt = gen_prompt + "2. What is the company's email pattern? (look for other employee emails)\n";
						gen_prompt = gen_prompt + "3. Which email from the list is most likely correct?\n\n";
						gen_prompt = gen_prompt + "Return ONLY valid JSON:\n";
						gen_prompt = gen_prompt + "{\"person_exists\": true, \"linkedin_found\": true, \"linkedin_url\": \"url\", \"company_page_found\": true, \"detected_pattern\": \"firstname.lastname\", \"best_email\": \"" + gen_emails.get(0) + "\", \"confidence\": \"high\"}";
						
						gen_items = List();
						gen_item = Map();
						gen_item.put("role", "user");
						gen_item.put("content", gen_prompt);
						gen_items.add(gen_item);
						
						gen_body = Map();
						gen_body.put("model", "sonar");
						gen_body.put("messages", gen_items);
						gen_body.put("temperature", 0);
						
						try
						{
							gen_resp = invokeurl
							[
								url: "https://api.perplexity.ai/chat/completions"
								type: POST
								body: gen_body.toString()
								headers: headers
							];
							
							if(gen_resp != null && gen_resp.containsKey("choices"))
							{
								gen_choices = gen_resp.get("choices");
								if(gen_choices != null && gen_choices.size() > 0)
								{
									gen_first_choice = gen_choices.get(0);
									if(gen_first_choice != null && gen_first_choice.containsKey("message"))
									{
										gen_msg = gen_first_choice.get("message");
										if(gen_msg != null && gen_msg.containsKey("content"))
										{
											gen_raw = gen_msg.get("content");
											
											// Extract JSON
											gen_json = gen_raw;
											gen_s = gen_raw.indexOf("{");
											gen_e = gen_raw.lastIndexOf("}");
											if(gen_s >= 0 && gen_e > gen_s)
											{
												gen_json = gen_raw.subString(gen_s, gen_e + 1);
											}
											
											try
											{
												gen_data = gen_json.toMap();
												
												// Get the best email from response
												if(gen_data.containsKey("best_email"))
												{
													gen_best = gen_data.get("best_email");
													if(gen_best != null && (gen_best + "").trim() != "" && (gen_best + "").indexOf("@") > 0)
													{
														// Use this as the primary email
														primary_email = (gen_best + "").trim().toLowerCase();
														primary_contact.put("email", primary_email);
														primary_contact.put("email_generated", true);
														primary_contact.put("email_source", "pattern_generation");
														
														// Store validation signals from generation
														gen_validation = Map();
														gen_validation.put("generated_from_name", pv_name);
														gen_validation.put("patterns_tried", gen_emails);
														
														if(gen_data.containsKey("person_exists"))
														{
															gen_validation.put("person_exists", gen_data.get("person_exists"));
														}
														if(gen_data.containsKey("linkedin_found"))
														{
															gen_validation.put("linkedin_found", gen_data.get("linkedin_found"));
														}
														if(gen_data.containsKey("linkedin_url"))
														{
															gen_validation.put("linkedin_url", gen_data.get("linkedin_url"));
														}
														if(gen_data.containsKey("detected_pattern"))
														{
															gen_validation.put("detected_pattern", gen_data.get("detected_pattern"));
														}
														if(gen_data.containsKey("confidence"))
														{
															gen_validation.put("generation_confidence", gen_data.get("confidence"));
														}
														
														primary_contact.put("email_generation_info", gen_validation);
													}
												}
											}
											catch(gen_e_parse)
											{
												// Failed to parse generation response
											}
										}
									}
								}
							}
						}
						catch(gen_e_call)
						{
							// Generation API call failed
						}
					}
				}
			}
			
			// Now validate the email (whether found by Perplexity or generated)
			if(primary_email != null && (primary_email + "").trim() != "" && (primary_email + "").trim() != "null")
			{
				pv_email = (primary_email + "").trim().toLowerCase();
				pv_name = ps.get("name");
				pv_title = ps.get("job_title");
				
				// Initialize validation result
				pv_result = Map();
				pv_result.put("email", pv_email);
				pv_result.put("syntax_valid", false);
				pv_result.put("mx_found", false);
				pv_result.put("confidence_score", 0);
				pv_result.put("confidence_level", "low");
				pv_evidence = List();
				pv_signals = Map();
				pv_score = 0;
				
				// SIGNAL 1: Syntax validation
				pv_syntax_ok = false;
				pv_atPos = pv_email.indexOf("@");
				if(pv_atPos > 0)
				{
					pv_afterAt = pv_email.subString(pv_atPos + 1, pv_email.length());
					pv_secondAt = pv_afterAt.indexOf("@");
					if(pv_secondAt < 0)
					{
						pv_dotPos = pv_afterAt.indexOf(".");
						if(pv_dotPos > 0 && pv_dotPos < pv_afterAt.length() - 1)
						{
							pv_syntax_ok = true;
						}
					}
				}
				pv_result.put("syntax_valid", pv_syntax_ok);
				pv_signals.put("syntax_valid", pv_syntax_ok);
				
				if(pv_syntax_ok == true)
				{
					pv_score = pv_score + 10;
					pv_evidence.add("Valid email syntax");
					
					// Extract domain for MX check
					pv_domain = pv_email.subString(pv_atPos + 1, pv_email.length());
					
					// SIGNAL 2: MX Record check via Google DNS
					pv_mx_found = false;
					pv_dns_url = "https://dns.google/resolve?name=" + pv_domain + "&type=MX";
					try
					{
						pv_dns_resp = invokeurl
						[
							url: pv_dns_url
							type: GET
						];
						if(pv_dns_resp != null && pv_dns_resp.containsKey("Answer"))
						{
							pv_answers = pv_dns_resp.get("Answer");
							if(pv_answers != null && pv_answers.size() > 0)
							{
								pv_mx_found = true;
							}
						}
					}
					catch(pv_e_dns)
					{
						// DNS lookup failed
					}
					
					pv_result.put("mx_found", pv_mx_found);
					pv_signals.put("mx_found", pv_mx_found);
					
					if(pv_mx_found == true)
					{
						pv_score = pv_score + 15;
						pv_evidence.add("Domain has valid MX records");
					}
					
					// SIGNAL 3: Email pattern analysis
					pv_local = pv_email.subString(0, pv_atPos);
					pv_pattern = "unknown";
					pv_local_dot = pv_local.indexOf(".");
					if(pv_local_dot > 0 && pv_local_dot < pv_local.length() - 1)
					{
						pv_before_dot = pv_local.subString(0, pv_local_dot);
						if(pv_before_dot.length() == 1)
						{
							pv_pattern = "f.lastname";
						}
						else
						{
							pv_pattern = "firstname.lastname";
						}
					}
					else
					{
						pv_local_underscore = pv_local.indexOf("_");
						if(pv_local_underscore > 0)
						{
							pv_pattern = "firstname_lastname";
						}
					}
					pv_signals.put("pattern", pv_pattern);
					
					if(pv_pattern == "firstname.lastname" || pv_pattern == "f.lastname" || pv_pattern == "firstname_lastname")
					{
						pv_score = pv_score + 5;
						pv_evidence.add("Email follows professional '" + pv_pattern + "' pattern");
					}
					
					// SIGNAL 4: Name extraction and matching
					if(pv_name != null && (pv_name + "").trim() != "" && (pv_name + "").trim() != "null")
					{
						pv_name_lower = (pv_name + "").trim().toLowerCase();
						
						// Extract name from email if firstname.lastname pattern
						if(pv_local_dot > 0 && pv_local_dot < pv_local.length() - 1)
						{
							pv_extracted_first = pv_local.subString(0, pv_local_dot);
							pv_extracted_last = pv_local.subString(pv_local_dot + 1, pv_local.length());
							pv_extracted_full = pv_extracted_first + " " + pv_extracted_last;
							
							if(pv_name_lower == pv_extracted_full)
							{
								pv_score = pv_score + 25;
								pv_evidence.add("Email name matches provided name exactly");
							}
							else if(pv_name_lower.indexOf(pv_extracted_first) >= 0)
							{
								pv_score = pv_score + 15;
								pv_evidence.add("Email first name found in provided name");
							}
						}
					}
					
					// SIGNAL 5: LinkedIn/Web validation via Perplexity
					if(pv_name != null && (pv_name + "").trim() != "" && (pv_name + "").trim() != "null")
					{
						pv_web_prompt = "Search the web to verify if this person and email are legitimate:\n\n";
						pv_web_prompt = pv_web_prompt + "Email: " + pv_email + "\n";
						pv_web_prompt = pv_web_prompt + "Name: " + pv_name + "\n";
						pv_web_prompt = pv_web_prompt + "Company: " + company_name_str + "\n";
						if(pv_title != null && (pv_title + "").trim() != "")
						{
							pv_web_prompt = pv_web_prompt + "Job Title: " + pv_title + "\n";
						}
						pv_web_prompt = pv_web_prompt + "\nSearch for:\n";
						pv_web_prompt = pv_web_prompt + "1. LinkedIn profile for " + pv_name + " at " + company_name_str + "\n";
						pv_web_prompt = pv_web_prompt + "2. The exact email \"" + pv_email + "\" on any public webpage\n";
						pv_web_prompt = pv_web_prompt + "3. " + pv_name + " mentioned on " + company_name_str + "'s website\n\n";
						pv_web_prompt = pv_web_prompt + "Return ONLY valid JSON:\n";
						pv_web_prompt = pv_web_prompt + "{\"person_exists_at_company\": true, \"linkedin_found\": true, \"linkedin_url\": \"url\", \"email_found_publicly\": false, \"company_page_found\": true}";
						
						pv_web_items = List();
						pv_web_item = Map();
						pv_web_item.put("role", "user");
						pv_web_item.put("content", pv_web_prompt);
						pv_web_items.add(pv_web_item);
						
						pv_web_body = Map();
						pv_web_body.put("model", "sonar");
						pv_web_body.put("messages", pv_web_items);
						pv_web_body.put("temperature", 0);
						
						try
						{
							pv_web_resp = invokeurl
							[
								url: "https://api.perplexity.ai/chat/completions"
								type: POST
								body: pv_web_body.toString()
								headers: headers
							];
							
							if(pv_web_resp != null && pv_web_resp.containsKey("choices"))
							{
								pv_web_choices = pv_web_resp.get("choices");
								if(pv_web_choices != null && pv_web_choices.size() > 0)
								{
									pv_web_first = pv_web_choices.get(0);
									if(pv_web_first != null && pv_web_first.containsKey("message"))
									{
										pv_web_msg = pv_web_first.get("message");
										if(pv_web_msg != null && pv_web_msg.containsKey("content"))
										{
											pv_web_raw = pv_web_msg.get("content");
											
											// Extract JSON
											pv_web_json = pv_web_raw;
											pv_web_s = pv_web_raw.indexOf("{");
											pv_web_e = pv_web_raw.lastIndexOf("}");
											if(pv_web_s >= 0 && pv_web_e > pv_web_s)
											{
												pv_web_json = pv_web_raw.subString(pv_web_s, pv_web_e + 1);
											}
											
											pv_web_data = pv_web_json.toMap();
											
											if(pv_web_data.containsKey("person_exists_at_company"))
											{
												if(pv_web_data.get("person_exists_at_company") == true)
												{
													pv_score = pv_score + 20;
													pv_evidence.add("Web search confirms " + pv_name + " works at " + company_name_str);
												}
											}
											
											if(pv_web_data.containsKey("linkedin_found"))
											{
												if(pv_web_data.get("linkedin_found") == true)
												{
													pv_score = pv_score + 15;
													pv_li_url = pv_web_data.get("linkedin_url");
													if(pv_li_url != null && (pv_li_url + "").trim() != "" && (pv_li_url + "").trim() != "null")
													{
														pv_evidence.add("LinkedIn profile: " + pv_li_url);
														pv_signals.put("linkedin_url", pv_li_url);
													}
													else
													{
														pv_evidence.add("LinkedIn profile found");
													}
													pv_signals.put("linkedin_found", true);
												}
											}
											
											if(pv_web_data.containsKey("email_found_publicly"))
											{
												if(pv_web_data.get("email_found_publicly") == true)
												{
													pv_score = pv_score + 25;
													pv_evidence.add("Email found publicly on web");
													pv_signals.put("email_found_publicly", true);
												}
											}
											
											if(pv_web_data.containsKey("company_page_found"))
											{
												if(pv_web_data.get("company_page_found") == true)
												{
													pv_score = pv_score + 15;
													pv_evidence.add("Person found on company website");
													pv_signals.put("company_page_found", true);
												}
											}
										}
									}
								}
							}
						}
						catch(pv_e_web)
						{
							// Web validation failed - continue without it
						}
					}
				}
				
				// Calculate confidence level
				pv_level = "low";
				pv_recommendation = "Email uncertain - could not validate";
				if(pv_score >= 70)
				{
					pv_level = "high";
					pv_recommendation = "Email highly likely valid - multiple signals confirm";
				}
				else if(pv_score >= 45)
				{
					pv_level = "medium";
					pv_recommendation = "Email likely valid - some confirming signals";
				}
				else if(pv_score >= 25)
				{
					pv_level = "low-medium";
					pv_recommendation = "Email possibly valid - limited validation";
				}
				
				pv_result.put("confidence_score", pv_score);
				pv_result.put("confidence_level", pv_level);
				pv_result.put("evidence", pv_evidence);
				pv_result.put("signals", pv_signals);
				pv_result.put("recommendation", pv_recommendation);
				
				primary_contact.put("email_validation", pv_result);
			}
		}
	}
	
	// Extract secondary stakeholder
	if(contact_map.containsKey("secondary_stakeholder"))
	{
		ss = contact_map.get("secondary_stakeholder");
		if(ss != null)
		{
			secondary_contact.put("name",ss.get("name"));
			secondary_contact.put("job_title",ss.get("job_title"));
			secondary_contact.put("company",ss.get("company"));
			secondary_contact.put("email",ss.get("email"));
			secondary_contact.put("phone",ss.get("phone"));
			secondary_contact.put("location",ss.get("location"));
			secondary_contact.put("linkedin_url",ss.get("linkedin_url"));
			secondary_contact.put("company_website",ss.get("company_website"));
			secondary_contact.put("source_url",ss.get("source_url"));
			secondary_contact.put("notes",ss.get("notes"));
			
			// ========== EMAIL GENERATION + VALIDATION FOR SECONDARY ==========
			secondary_email = ss.get("email");
			sv_name = ss.get("name");
			sv_title = ss.get("job_title");
			
			// If no email found but we have a name, GENERATE probable emails
			if((secondary_email == null || (secondary_email + "").trim() == "" || (secondary_email + "").trim() == "null") && sv_name != null && (sv_name + "").trim() != "" && (sv_name + "").trim() != "null")
			{
				// Parse name into first and last
				sv_gen_full_name = (sv_name + "").trim().toLowerCase();
				sv_gen_first = "";
				sv_gen_last = "";
				
				sv_gen_space_pos = sv_gen_full_name.indexOf(" ");
				if(sv_gen_space_pos > 0)
				{
					sv_gen_first = sv_gen_full_name.subString(0, sv_gen_space_pos);
					sv_gen_last = sv_gen_full_name.subString(sv_gen_space_pos + 1, sv_gen_full_name.length());
					
					sv_gen_last_space = sv_gen_last.lastIndexOf(" ");
					if(sv_gen_last_space > 0)
					{
						sv_gen_last = sv_gen_last.subString(sv_gen_last_space + 1, sv_gen_last.length());
					}
				}
				
				// Clean names - remove apostrophes, hyphens
				sv_gen_first_clean = "";
				for each sv_char_idx in sv_gen_first.length().range(0, sv_gen_first.length())
				{
					sv_gen_char = sv_gen_first.subString(sv_char_idx, sv_char_idx + 1);
					if(sv_gen_char != "'" && sv_gen_char != "-" && sv_gen_char != " ")
					{
						sv_gen_first_clean = sv_gen_first_clean + sv_gen_char;
					}
				}
				
				sv_gen_last_clean = "";
				for each sv_char_idx2 in sv_gen_last.length().range(0, sv_gen_last.length())
				{
					sv_gen_char2 = sv_gen_last.subString(sv_char_idx2, sv_char_idx2 + 1);
					if(sv_gen_char2 != "'" && sv_gen_char2 != "-" && sv_gen_char2 != " ")
					{
						sv_gen_last_clean = sv_gen_last_clean + sv_gen_char2;
					}
				}
				
				// Generate email patterns
				if(sv_gen_first_clean != "" && sv_gen_last_clean != "")
				{
					sv_gen_emails = List();
					sv_gen_emails.add(sv_gen_first_clean + "." + sv_gen_last_clean + "@" + domain);
					sv_gen_emails.add(sv_gen_first_clean.subString(0, 1) + "." + sv_gen_last_clean + "@" + domain);
					sv_gen_emails.add(sv_gen_first_clean + "@" + domain);
					sv_gen_emails.add(sv_gen_first_clean + sv_gen_last_clean + "@" + domain);
					sv_gen_emails.add(sv_gen_first_clean.subString(0, 1) + sv_gen_last_clean + "@" + domain);
					
					// Check MX records
					sv_gen_mx_found = false;
					sv_gen_dns_url = "https://dns.google/resolve?name=" + domain + "&type=MX";
					try
					{
						sv_gen_dns_resp = invokeurl
						[
							url: sv_gen_dns_url
							type: GET
						];
						if(sv_gen_dns_resp != null && sv_gen_dns_resp.containsKey("Answer"))
						{
							sv_gen_answers = sv_gen_dns_resp.get("Answer");
							if(sv_gen_answers != null && sv_gen_answers.size() > 0)
							{
								sv_gen_mx_found = true;
							}
						}
					}
					catch(sv_gen_e_dns)
					{
						// DNS lookup failed
					}
					
					if(sv_gen_mx_found == true)
					{
						// Validate generated emails using Perplexity
						sv_gen_prompt = "Search the web to find the email address for:\n\n";
						sv_gen_prompt = sv_gen_prompt + "Name: " + sv_name + "\n";
						sv_gen_prompt = sv_gen_prompt + "Company: " + company_name_str + "\n";
						sv_gen_prompt = sv_gen_prompt + "Domain: " + domain + "\n";
						if(sv_title != null && (sv_title + "").trim() != "")
						{
							sv_gen_prompt = sv_gen_prompt + "Job Title: " + sv_title + "\n";
						}
						sv_gen_prompt = sv_gen_prompt + "\nPossible email addresses:\n";
						sv_gen_prompt = sv_gen_prompt + "1. " + sv_gen_emails.get(0) + "\n";
						sv_gen_prompt = sv_gen_prompt + "2. " + sv_gen_emails.get(1) + "\n";
						sv_gen_prompt = sv_gen_prompt + "3. " + sv_gen_emails.get(2) + "\n";
						sv_gen_prompt = sv_gen_prompt + "4. " + sv_gen_emails.get(3) + "\n";
						sv_gen_prompt = sv_gen_prompt + "5. " + sv_gen_emails.get(4) + "\n";
						sv_gen_prompt = sv_gen_prompt + "\nDetermine:\n";
						sv_gen_prompt = sv_gen_prompt + "1. Does this person exist at this company?\n";
						sv_gen_prompt = sv_gen_prompt + "2. What is the company's email pattern?\n";
						sv_gen_prompt = sv_gen_prompt + "3. Which email is most likely correct?\n\n";
						sv_gen_prompt = sv_gen_prompt + "Return ONLY valid JSON:\n";
						sv_gen_prompt = sv_gen_prompt + "{\"person_exists\": true, \"linkedin_found\": true, \"linkedin_url\": \"url\", \"company_page_found\": true, \"detected_pattern\": \"firstname.lastname\", \"best_email\": \"" + sv_gen_emails.get(0) + "\", \"confidence\": \"high\"}";
						
						sv_gen_items = List();
						sv_gen_item = Map();
						sv_gen_item.put("role", "user");
						sv_gen_item.put("content", sv_gen_prompt);
						sv_gen_items.add(sv_gen_item);
						
						sv_gen_body = Map();
						sv_gen_body.put("model", "sonar");
						sv_gen_body.put("messages", sv_gen_items);
						sv_gen_body.put("temperature", 0);
						
						try
						{
							sv_gen_resp = invokeurl
							[
								url: "https://api.perplexity.ai/chat/completions"
								type: POST
								body: sv_gen_body.toString()
								headers: headers
							];
							
							if(sv_gen_resp != null && sv_gen_resp.containsKey("choices"))
							{
								sv_gen_choices = sv_gen_resp.get("choices");
								if(sv_gen_choices != null && sv_gen_choices.size() > 0)
								{
									sv_gen_first_choice = sv_gen_choices.get(0);
									if(sv_gen_first_choice != null && sv_gen_first_choice.containsKey("message"))
									{
										sv_gen_msg = sv_gen_first_choice.get("message");
										if(sv_gen_msg != null && sv_gen_msg.containsKey("content"))
										{
											sv_gen_raw = sv_gen_msg.get("content");
											
											sv_gen_json = sv_gen_raw;
											sv_gen_s = sv_gen_raw.indexOf("{");
											sv_gen_e = sv_gen_raw.lastIndexOf("}");
											if(sv_gen_s >= 0 && sv_gen_e > sv_gen_s)
											{
												sv_gen_json = sv_gen_raw.subString(sv_gen_s, sv_gen_e + 1);
											}
											
											try
											{
												sv_gen_data = sv_gen_json.toMap();
												
												if(sv_gen_data.containsKey("best_email"))
												{
													sv_gen_best = sv_gen_data.get("best_email");
													if(sv_gen_best != null && (sv_gen_best + "").trim() != "" && (sv_gen_best + "").indexOf("@") > 0)
													{
														secondary_email = (sv_gen_best + "").trim().toLowerCase();
														secondary_contact.put("email", secondary_email);
														secondary_contact.put("email_generated", true);
														secondary_contact.put("email_source", "pattern_generation");
														
														sv_gen_validation = Map();
														sv_gen_validation.put("generated_from_name", sv_name);
														sv_gen_validation.put("patterns_tried", sv_gen_emails);
														
														if(sv_gen_data.containsKey("person_exists"))
														{
															sv_gen_validation.put("person_exists", sv_gen_data.get("person_exists"));
														}
														if(sv_gen_data.containsKey("linkedin_found"))
														{
															sv_gen_validation.put("linkedin_found", sv_gen_data.get("linkedin_found"));
														}
														if(sv_gen_data.containsKey("linkedin_url"))
														{
															sv_gen_validation.put("linkedin_url", sv_gen_data.get("linkedin_url"));
														}
														if(sv_gen_data.containsKey("detected_pattern"))
														{
															sv_gen_validation.put("detected_pattern", sv_gen_data.get("detected_pattern"));
														}
														if(sv_gen_data.containsKey("confidence"))
														{
															sv_gen_validation.put("generation_confidence", sv_gen_data.get("confidence"));
														}
														
														secondary_contact.put("email_generation_info", sv_gen_validation);
													}
												}
											}
											catch(sv_gen_e_parse)
											{
												// Failed to parse
											}
										}
									}
								}
							}
						}
						catch(sv_gen_e_call)
						{
							// API call failed
						}
					}
				}
			}
			
			// Now validate the email (whether found or generated)
			if(secondary_email != null && (secondary_email + "").trim() != "" && (secondary_email + "").trim() != "null")
			{
				sv_email = (secondary_email + "").trim().toLowerCase();
				
				// Initialize validation result
				sv_result = Map();
				sv_result.put("email", sv_email);
				sv_result.put("syntax_valid", false);
				sv_result.put("mx_found", false);
				sv_result.put("confidence_score", 0);
				sv_result.put("confidence_level", "low");
				sv_evidence = List();
				sv_signals = Map();
				sv_score = 0;
				
				// SIGNAL 1: Syntax validation
				sv_syntax_ok = false;
				sv_atPos = sv_email.indexOf("@");
				if(sv_atPos > 0)
				{
					sv_afterAt = sv_email.subString(sv_atPos + 1, sv_email.length());
					sv_secondAt = sv_afterAt.indexOf("@");
					if(sv_secondAt < 0)
					{
						sv_dotPos = sv_afterAt.indexOf(".");
						if(sv_dotPos > 0 && sv_dotPos < sv_afterAt.length() - 1)
						{
							sv_syntax_ok = true;
						}
					}
				}
				sv_result.put("syntax_valid", sv_syntax_ok);
				sv_signals.put("syntax_valid", sv_syntax_ok);
				
				if(sv_syntax_ok == true)
				{
					sv_score = sv_score + 10;
					sv_evidence.add("Valid email syntax");
					
					// Extract domain for MX check
					sv_domain = sv_email.subString(sv_atPos + 1, sv_email.length());
					
					// SIGNAL 2: MX Record check
					sv_mx_found = false;
					sv_dns_url = "https://dns.google/resolve?name=" + sv_domain + "&type=MX";
					try
					{
						sv_dns_resp = invokeurl
						[
							url: sv_dns_url
							type: GET
						];
						if(sv_dns_resp != null && sv_dns_resp.containsKey("Answer"))
						{
							sv_answers = sv_dns_resp.get("Answer");
							if(sv_answers != null && sv_answers.size() > 0)
							{
								sv_mx_found = true;
							}
						}
					}
					catch(sv_e_dns)
					{
						// DNS lookup failed
					}
					
					sv_result.put("mx_found", sv_mx_found);
					sv_signals.put("mx_found", sv_mx_found);
					
					if(sv_mx_found == true)
					{
						sv_score = sv_score + 15;
						sv_evidence.add("Domain has valid MX records");
					}
					
					// SIGNAL 3: Email pattern analysis
					sv_local = sv_email.subString(0, sv_atPos);
					sv_pattern = "unknown";
					sv_local_dot = sv_local.indexOf(".");
					if(sv_local_dot > 0 && sv_local_dot < sv_local.length() - 1)
					{
						sv_before_dot = sv_local.subString(0, sv_local_dot);
						if(sv_before_dot.length() == 1)
						{
							sv_pattern = "f.lastname";
						}
						else
						{
							sv_pattern = "firstname.lastname";
						}
					}
					else
					{
						sv_local_underscore = sv_local.indexOf("_");
						if(sv_local_underscore > 0)
						{
							sv_pattern = "firstname_lastname";
						}
					}
					sv_signals.put("pattern", sv_pattern);
					
					if(sv_pattern == "firstname.lastname" || sv_pattern == "f.lastname" || sv_pattern == "firstname_lastname")
					{
						sv_score = sv_score + 5;
						sv_evidence.add("Email follows professional '" + sv_pattern + "' pattern");
					}
					
					// SIGNAL 4: Name extraction and matching
					if(sv_name != null && (sv_name + "").trim() != "" && (sv_name + "").trim() != "null")
					{
						sv_name_lower = (sv_name + "").trim().toLowerCase();
						
						if(sv_local_dot > 0 && sv_local_dot < sv_local.length() - 1)
						{
							sv_extracted_first = sv_local.subString(0, sv_local_dot);
							sv_extracted_last = sv_local.subString(sv_local_dot + 1, sv_local.length());
							sv_extracted_full = sv_extracted_first + " " + sv_extracted_last;
							
							if(sv_name_lower == sv_extracted_full)
							{
								sv_score = sv_score + 25;
								sv_evidence.add("Email name matches provided name exactly");
							}
							else if(sv_name_lower.indexOf(sv_extracted_first) >= 0)
							{
								sv_score = sv_score + 15;
								sv_evidence.add("Email first name found in provided name");
							}
						}
					}
					
					// SIGNAL 5: LinkedIn/Web validation via Perplexity
					if(sv_name != null && (sv_name + "").trim() != "" && (sv_name + "").trim() != "null")
					{
						sv_web_prompt = "Search the web to verify if this person and email are legitimate:\n\n";
						sv_web_prompt = sv_web_prompt + "Email: " + sv_email + "\n";
						sv_web_prompt = sv_web_prompt + "Name: " + sv_name + "\n";
						sv_web_prompt = sv_web_prompt + "Company: " + company_name_str + "\n";
						if(sv_title != null && (sv_title + "").trim() != "")
						{
							sv_web_prompt = sv_web_prompt + "Job Title: " + sv_title + "\n";
						}
						sv_web_prompt = sv_web_prompt + "\nSearch for:\n";
						sv_web_prompt = sv_web_prompt + "1. LinkedIn profile for " + sv_name + " at " + company_name_str + "\n";
						sv_web_prompt = sv_web_prompt + "2. The exact email \"" + sv_email + "\" on any public webpage\n";
						sv_web_prompt = sv_web_prompt + "3. " + sv_name + " mentioned on " + company_name_str + "'s website\n\n";
						sv_web_prompt = sv_web_prompt + "Return ONLY valid JSON:\n";
						sv_web_prompt = sv_web_prompt + "{\"person_exists_at_company\": true, \"linkedin_found\": true, \"linkedin_url\": \"url\", \"email_found_publicly\": false, \"company_page_found\": true}";
						
						sv_web_items = List();
						sv_web_item = Map();
						sv_web_item.put("role", "user");
						sv_web_item.put("content", sv_web_prompt);
						sv_web_items.add(sv_web_item);
						
						sv_web_body = Map();
						sv_web_body.put("model", "sonar");
						sv_web_body.put("messages", sv_web_items);
						sv_web_body.put("temperature", 0);
						
						try
						{
							sv_web_resp = invokeurl
							[
								url: "https://api.perplexity.ai/chat/completions"
								type: POST
								body: sv_web_body.toString()
								headers: headers
							];
							
							if(sv_web_resp != null && sv_web_resp.containsKey("choices"))
							{
								sv_web_choices = sv_web_resp.get("choices");
								if(sv_web_choices != null && sv_web_choices.size() > 0)
								{
									sv_web_first = sv_web_choices.get(0);
									if(sv_web_first != null && sv_web_first.containsKey("message"))
									{
										sv_web_msg = sv_web_first.get("message");
										if(sv_web_msg != null && sv_web_msg.containsKey("content"))
										{
											sv_web_raw = sv_web_msg.get("content");
											
											sv_web_json = sv_web_raw;
											sv_web_s = sv_web_raw.indexOf("{");
											sv_web_e = sv_web_raw.lastIndexOf("}");
											if(sv_web_s >= 0 && sv_web_e > sv_web_s)
											{
												sv_web_json = sv_web_raw.subString(sv_web_s, sv_web_e + 1);
											}
											
											sv_web_data = sv_web_json.toMap();
											
											if(sv_web_data.containsKey("person_exists_at_company"))
											{
												if(sv_web_data.get("person_exists_at_company") == true)
												{
													sv_score = sv_score + 20;
													sv_evidence.add("Web search confirms " + sv_name + " works at " + company_name_str);
												}
											}
											
											if(sv_web_data.containsKey("linkedin_found"))
											{
												if(sv_web_data.get("linkedin_found") == true)
												{
													sv_score = sv_score + 15;
													sv_li_url = sv_web_data.get("linkedin_url");
													if(sv_li_url != null && (sv_li_url + "").trim() != "" && (sv_li_url + "").trim() != "null")
													{
														sv_evidence.add("LinkedIn profile: " + sv_li_url);
														sv_signals.put("linkedin_url", sv_li_url);
													}
													else
													{
														sv_evidence.add("LinkedIn profile found");
													}
													sv_signals.put("linkedin_found", true);
												}
											}
											
											if(sv_web_data.containsKey("email_found_publicly"))
											{
												if(sv_web_data.get("email_found_publicly") == true)
												{
													sv_score = sv_score + 25;
													sv_evidence.add("Email found publicly on web");
													sv_signals.put("email_found_publicly", true);
												}
											}
											
											if(sv_web_data.containsKey("company_page_found"))
											{
												if(sv_web_data.get("company_page_found") == true)
												{
													sv_score = sv_score + 15;
													sv_evidence.add("Person found on company website");
													sv_signals.put("company_page_found", true);
												}
											}
										}
									}
								}
							}
						}
						catch(sv_e_web)
						{
							// Web validation failed
						}
					}
				}
				
				// Calculate confidence level
				sv_level = "low";
				sv_recommendation = "Email uncertain - could not validate";
				if(sv_score >= 70)
				{
					sv_level = "high";
					sv_recommendation = "Email highly likely valid - multiple signals confirm";
				}
				else if(sv_score >= 45)
				{
					sv_level = "medium";
					sv_recommendation = "Email likely valid - some confirming signals";
				}
				else if(sv_score >= 25)
				{
					sv_level = "low-medium";
					sv_recommendation = "Email possibly valid - limited validation";
				}
				
				sv_result.put("confidence_score", sv_score);
				sv_result.put("confidence_level", sv_level);
				sv_result.put("evidence", sv_evidence);
				sv_result.put("signals", sv_signals);
				sv_result.put("recommendation", sv_recommendation);
				
				secondary_contact.put("email_validation", sv_result);
			}
		}
	}
	
	if(contact_map.containsKey("email_pattern_hint"))
	{
		email_pattern = contact_map.get("email_pattern_hint");
	}
	
	contacts_result = Map();
	contacts_result.put("primary_contact",primary_contact);
	contacts_result.put("secondary_contact",secondary_contact);
	contacts_result.put("email_pattern",email_pattern);
	if(contact_map.containsKey("email_examples"))
	{
		contacts_result.put("email_examples",contact_map.get("email_examples"));
	}
	company_result = Map();
	company_result.put("company_name",company_name);
	company_result.put("company_website",website);
	company_result.put("company_domain",domain);
	company_result.put("discovered_sector",comp2.get("sector"));
	company_result.put("employee_size",comp2.get("employee_size"));
	company_result.put("location",comp2.get("location"));
	company_result.put("contacts",contacts_result);
	results.add(company_result);
	if(results.size() >= max_companies)
	{
		break;
	}
}
out.put("status","OK");
out.put("sector",requested_sector);
out.put("company_size",requested_size);
out.put("job_title",target_job_title);
out.put("result_count",results.size());
out.put("results",results);
info out;
}
}
