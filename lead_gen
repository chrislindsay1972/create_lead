void automation.lead_gen(String sector,String company_size,String jobTitle)
{
out = Map();
// End-to-end: discover UK companies for a sector + size (up to 20, paginated),
// then enrich each company with TWO contacts (primary + secondary) and email pattern info.
//
// Constraints respected:
// - NO while
// - NO ternary
// - NO replace()
// - NO split()   <-- IMPORTANT (uses indexOf/subString only)
//
// Usage example:
// result = automation.lead_gen("finance","100","CFO");
// -----------------------------------------
// Perplexity API config
// -----------------------------------------
PERPLEXITY_API_KEY = zoho.crm.getOrgVariable("PERPLEXITY_API_KEY");
api_key_valid = false;
if(PERPLEXITY_API_KEY != null && PERPLEXITY_API_KEY.trim() != "")
{
	api_key_valid = true;
}
if(api_key_valid == false)
{
	out.put("status","ERROR");
	out.put("message","PERPLEXITY_API_KEY not configured. Please set the org variable.");
	info out;
}
if(api_key_valid == true)
{
// Use sonar model for web search capability
MODEL = "sonar";
headers = Map();
headers.put("Authorization","Bearer " + PERPLEXITY_API_KEY);
headers.put("Content-Type","application/json");
// -----------------------------------------
// Inputs / defaults
// -----------------------------------------
requested_sector = "";
if(sector != null)
{
	requested_sector = sector.trim().toLowerCase();
}
requested_size = "";
if(company_size != null)
{
	requested_size = company_size.trim();
}
target_job_title = "";
if(jobTitle != null)
{
	target_job_title = jobTitle.trim();
}
// -----------------------------------------
// Helper: parse company_size into a normalised filter (NO split)
// Supports:
// - "100" (single number => match ranges containing it)
// - "51-200" (range)
// - "1000+" (min)
// -----------------------------------------
size_filter_type = "unknown";
// "single" | "range" | "min" | "unknown"
size_single = 0;
size_lower = 0;
size_upper = 0;
size_min = 0;
if(requested_size != "")
{
	if(requested_size.contains("-"))
	{
		dashPos = requested_size.indexOf("-");
		if(dashPos > 0 && dashPos < requested_size.length() - 1)
		{
			try 
			{
				leftPart = requested_size.subString(0,dashPos).trim();
				rightPart = requested_size.subString(dashPos + 1,requested_size.length()).trim();
				size_lower = leftPart.toLong();
				size_upper = rightPart.toLong();
				size_filter_type = "range";
			}
			catch (e_size_range)
			{
				size_filter_type = "unknown";
			}
		}
	}
	else if(requested_size.endsWith("+"))
	{
		try 
		{
			min_str = requested_size.subString(0,requested_size.length() - 1).trim();
			size_min = min_str.toLong();
			size_filter_type = "min";
		}
		catch (e_size_min)
		{
			size_filter_type = "unknown";
		}
	}
	else
	{
		try 
		{
			size_single = requested_size.toLong();
			size_filter_type = "single";
		}
		catch (e_size_single)
		{
			size_filter_type = "unknown";
		}
	}
}
// -----------------------------------------
// Pagination controls (NO while)
// Attempt 3 pages * 10 = 30 candidates, then trim to 20.
// -----------------------------------------
max_companies = 20;
page_size = 10;
pages_seed = List();
pages_seed.add(1);
pages_seed.add(2);
pages_seed.add(3);
next_page_token = null;
companies_found = List();
// -----------------------------------------
// CALL A: Company discovery pages (UK) - Using Perplexity with web search
// -----------------------------------------
for each  page in pages_seed
{
	if(companies_found.size() >= max_companies)
	{
		break;
	}
	if(page != 1)
	{
		if(next_page_token == null || (next_page_token + "").trim() == "")
		{
			break;
		}
	}
	token_str = "null";
	if(next_page_token != null && (next_page_token + "").trim() != "")
	{
		token_str = next_page_token;
	}
	promptA = "Search the web and find UK companies in the " + requested_sector + " sector with approximately " + requested_size + " employees.\n\n" + "Page: " + page + " of results (return " + page_size + " companies per page).\n\n" + "For each company, search for and provide:\n" + "1. Company name\n" + "2. Official website URL\n" + "3. Employee size range (e.g., '1-10', '11-50', '51-200', '201-500', '501-1000', '1000+')\n" + "4. Location (city, UK)\n" + "5. Specific sector/industry\n\n" + "Return ONLY a valid JSON object with no markdown formatting, no code blocks, no explanation.\n" + "The response must start with { and end with }\n\n" + "JSON schema:\n" + "{\n" + "  \"companies\": [\n" + "    {\"name\": \"Company Name\", \"website\": \"https://example.com\", \"employee_size\": \"51-200\", \"location\": \"London, UK\", \"sector\": \"Finance\", \"source_url\": \"https://source.com\"}\n" + "  ],\n" + "  \"next_page_token\": \"page2\" \n" + "}\n\n" + "Set next_page_token to null if no more results exist.";
	input_items_A = List();
	user_item_A = Map();
	user_item_A.put("role","user");
	user_item_A.put("content",promptA);
	input_items_A.add(user_item_A);
	body_A = Map();
	body_A.put("model",MODEL);
	body_A.put("messages",input_items_A);
	body_A.put("temperature",0);
	respA = null;
	rawA = null;
	try 
	{
		respA = invokeurl
		[
			url :"https://api.perplexity.ai/chat/completions"
			type :POST
			body:body_A.toString()
			headers:headers
		];
	}
	catch (e_callA)
	{
		info "Discovery API call failed: " + e_callA;
		continue;
	}
	// Extract assistant text from Perplexity response (OpenAI-compatible format)
	try 
	{
		if(respA != null && respA.containsKey("choices"))
		{
			choices_A = respA.get("choices");
			if(choices_A != null && choices_A.size() > 0)
			{
				first_choice_A = choices_A.get(0);
				if(first_choice_A != null && first_choice_A.containsKey("message"))
				{
					message_A = first_choice_A.get("message");
					if(message_A != null && message_A.containsKey("content"))
					{
						rawA = message_A.get("content");
					}
				}
			}
		}
	}
	catch (eA_extract)
	{
		rawA = null;
	}
	if(rawA == null || rawA.trim() == "")
	{
		continue;
	}
	// Slice JSON from response
	jsonA = rawA;
	try 
	{
		sA = rawA.indexOf("{");
		eA = rawA.lastIndexOf("}");
		if(sA >= 0 && eA > sA)
		{
			jsonA = rawA.subString(sA,eA + 1);
		}
	}
	catch (eA_slice)
	{
		jsonA = rawA;
	}
	disc_map = null;
	try 
	{
		disc_map = jsonA.toMap();
	}
	catch (eA_parse)
	{
		info "Failed to parse discovery JSON: " + jsonA;
		continue;
	}
	page_companies = disc_map.get("companies");
	if(page_companies == null)
	{
		page_companies = List();
	}
	next_page_token = disc_map.get("next_page_token");
	// Add companies to companies_found (dedupe by website)
	for each  c in page_companies
	{
		if(c == null)
		{
			continue;
		}
		if(companies_found.size() >= max_companies)
		{
			break;
		}
		w = c.get("website");
		if(w == null || (w + "").trim() == "")
		{
			continue;
		}
		wlc = (w + "").trim().toLowerCase();
		// Remove https:// prefix using subString (NO replace)
		if(wlc.startsWith("https://"))
		{
			wlc = wlc.subString(8,wlc.length());
		}
		else if(wlc.startsWith("http://"))
		{
			wlc = wlc.subString(7,wlc.length());
		}
		if(wlc.endsWith("/"))
		{
			wlc = wlc.subString(0,wlc.length() - 1);
		}
		already = false;
		for each  existing in companies_found
		{
			if(existing != null && existing.get("website") != null)
			{
				exw = (existing.get("website") + "").trim().toLowerCase();
				// Remove https:// prefix using subString (NO replace)
				if(exw.startsWith("https://"))
				{
					exw = exw.subString(8,exw.length());
				}
				else if(exw.startsWith("http://"))
				{
					exw = exw.subString(7,exw.length());
				}
				if(exw.endsWith("/"))
				{
					exw = exw.subString(0,exw.length() - 1);
				}
				if(exw == wlc)
				{
					already = true;
					break;
				}
			}
		}
		if(already == false)
		{
			companies_found.add(c);
		}
	}
}
// -----------------------------------------
// Filter companies by size + sector (best-effort)
// -----------------------------------------
matching_companies = List();
for each  comp in companies_found
{
	if(comp == null)
	{
		continue;
	}
	comp_sector = "";
	if(comp.get("sector") != null)
	{
		comp_sector = (comp.get("sector") + "").trim().toLowerCase();
	}
	comp_size = "";
	if(comp.get("employee_size") != null)
	{
		comp_size = (comp.get("employee_size") + "").trim();
	}
	// sector match
	sector_match = false;
	if(requested_sector == "")
	{
		sector_match = true;
	}
	else
	{
		if(comp_sector != "" && (comp_sector.indexOf(requested_sector) >= 0 || requested_sector.indexOf(comp_sector) >= 0))
		{
			sector_match = true;
		}
		if(sector_match == false && requested_sector == "finance")
		{
			if(comp_sector == "fintech" || comp_sector == "accounting" || comp_sector == "professional services")
			{
				sector_match = true;
			}
		}
	}
	// size match (NO split)
	size_match = false;
	if(requested_size == "" || size_filter_type == "unknown")
	{
		size_match = true;
	}
	else
	{
		comp_low = 0;
		comp_high = 0;
		if(comp_size != "")
		{
			if(comp_size.contains("-"))
			{
				d2 = comp_size.indexOf("-");
				if(d2 > 0 && d2 < comp_size.length() - 1)
				{
					try 
					{
						cl = comp_size.subString(0,d2).trim().toLong();
						ch = comp_size.subString(d2 + 1,comp_size.length()).trim().toLong();
						comp_low = cl;
						comp_high = ch;
					}
					catch (e_cs1)
					{
						comp_low = 0;
						comp_high = 0;
					}
				}
			}
			else if(comp_size.endsWith("+"))
			{
				try 
				{
					cmin = comp_size.subString(0,comp_size.length() - 1).trim().toLong();
					comp_low = cmin;
					comp_high = 999999;
				}
				catch (e_cs2)
				{
					comp_low = 0;
					comp_high = 999999;
				}
			}
		}
		if(size_filter_type == "single")
		{
			if(comp_high > 0 && size_single >= comp_low && size_single <= comp_high)
			{
				size_match = true;
			}
		}
		else if(size_filter_type == "range")
		{
			if(comp_high > 0)
			{
				if(!(comp_high < size_lower || comp_low > size_upper))
				{
					size_match = true;
				}
			}
		}
		else if(size_filter_type == "min")
		{
			if(comp_high > 0 && comp_high >= size_min)
			{
				size_match = true;
			}
		}
	}
	if(sector_match && size_match)
	{
		matching_companies.add(comp);
	}
	if(matching_companies.size() >= max_companies)
	{
		break;
	}
}
// -----------------------------------------
// Enrich each company with two contacts using Perplexity web search
// -----------------------------------------
results = List();
for each  comp2 in matching_companies
{
	website = null;
	if(comp2.get("website") != null)
	{
		website = (comp2.get("website") + "").trim();
	}
	if(website == null || website == "")
	{
		continue;
	}
	company_name = null;
	if(comp2.get("name") != null)
	{
		company_name = (comp2.get("name") + "").trim();
	}
	// Derive domain (NO replace - use subString)
	domain_lc = website.trim().toLowerCase();
	if(domain_lc.startsWith("https://"))
	{
		domain_lc = domain_lc.subString(8,domain_lc.length());
	}
	else if(domain_lc.startsWith("http://"))
	{
		domain_lc = domain_lc.subString(7,domain_lc.length());
	}
	slash_index = domain_lc.indexOf("/");
	if(slash_index > 0)
	{
		domain_lc = domain_lc.subString(0,slash_index);
	}
	colon_index = domain_lc.indexOf(":");
	if(colon_index > 0)
	{
		domain_lc = domain_lc.subString(0,colon_index);
	}
	if(domain_lc.startsWith("www."))
	{
		domain_lc = domain_lc.subString(4,domain_lc.length());
	}
	domain = domain_lc;
	// -------- CALL 1: Contact discovery with Perplexity web search (IMPROVED PROMPT)
	company_name_str = "Unknown Company";
	if(company_name != null && company_name.trim() != "")
	{
		company_name_str = company_name;
	}
	prompt1 = "Search the web thoroughly to find executive contact information for " + company_name_str + " (website: " + website + ", domain: " + domain + ").\n\n" + "PRIORITY SEARCH TARGETS:\n" + "1. PRIMARY: Find someone with job title '" + target_job_title + "' or equivalent (e.g., Chief Financial Officer, Finance Director)\n" + "2. SECONDARY: Find another C-level executive (CEO, COO, CTO, etc.)\n\n" + "SEARCH THESE SOURCES (in order of priority):\n" + "1. LinkedIn - Search 'site:linkedin.com/in " + company_name_str + " " + target_job_title + "' - GET THE FULL LINKEDIN URL\n" + "2. Company website About/Team/Leadership page at " + website + "\n" + "3. Companies House UK filings\n" + "4. Press releases and news articles\n" + "5. Crunchbase, ZoomInfo, RocketReach profiles\n\n" + "EMAIL DISCOVERY:\n" + "- Search for actual email addresses in press releases, job postings, contact pages\n" + "- Look for email patterns like: firstname@" + domain + ", firstname.lastname@" + domain + ", first.last@" + domain + "\n" + "- Check if company uses a different email domain than website\n\n" + "Return ONLY valid JSON. No markdown, no code blocks, no explanation.\n" + "Response must start with { and end with }\n\n" + "{\n" + "  \"primary_stakeholder\": {\n" + "    \"name\": \"Full Name or null\",\n" + "    \"job_title\": \"Exact Title or null\",\n" + "    \"company\": \"" + company_name_str + "\",\n" + "    \"email\": \"verified email or null\",\n" + "    \"phone\": \"phone number or null\",\n" + "    \"location\": \"City, Country or null\",\n" + "    \"linkedin_url\": \"https://linkedin.com/in/profilename or null\",\n" + "    \"company_website\": \"" + website + "\",\n" + "    \"source_url\": \"URL where you found this info\",\n" + "    \"notes\": \"How you found this person\"\n" + "  },\n" + "  \"secondary_stakeholder\": {\n" + "    \"name\": \"Full Name or null\",\n" + "    \"job_title\": \"Exact Title or null\",\n" + "    \"company\": \"" + company_name_str + "\",\n" + "    \"email\": \"verified email or null\",\n" + "    \"phone\": \"phone number or null\",\n" + "    \"location\": \"City, Country or null\",\n" + "    \"linkedin_url\": \"https://linkedin.com/in/profilename or null\",\n" + "    \"company_website\": \"" + website + "\",\n" + "    \"source_url\": \"URL where you found this info\",\n" + "    \"notes\": \"How you found this person\"\n" + "  },\n" + "  \"email_pattern_hint\": \"firstname.lastname@" + domain + " or null\",\n" + "  \"email_pattern_source\": \"Where you found this pattern\",\n" + "  \"email_examples\": [\"any verified emails found\"]\n" + "}\n";
	input_items_1 = List();
	user_item_1 = Map();
	user_item_1.put("role","user");
	user_item_1.put("content",prompt1);
	input_items_1.add(user_item_1);
	body_1 = Map();
	body_1.put("model",MODEL);
	body_1.put("messages",input_items_1);
	body_1.put("temperature",0);
	resp1 = null;
	raw1 = null;
	try 
	{
		resp1 = invokeurl
		[
			url :"https://api.perplexity.ai/chat/completions"
			type :POST
			body:body_1.toString()
			headers:headers
		];
	}
	catch (e_call1)
	{
		info "Contact discovery API call failed for " + company_name_str + ": " + e_call1;
		continue;
	}
	// Extract assistant text from Perplexity response
	try 
	{
		if(resp1 != null && resp1.containsKey("choices"))
		{
			choices_1 = resp1.get("choices");
			if(choices_1 != null && choices_1.size() > 0)
			{
				first_choice_1 = choices_1.get(0);
				if(first_choice_1 != null && first_choice_1.containsKey("message"))
				{
					message_1 = first_choice_1.get("message");
					if(message_1 != null && message_1.containsKey("content"))
					{
						raw1 = message_1.get("content");
					}
				}
			}
		}
	}
	catch (e_text1)
	{
		raw1 = null;
	}
	if(raw1 == null || raw1.trim() == "")
	{
		continue;
	}
	// Slice JSON from raw1
	json1 = raw1;
	try 
	{
		s1 = raw1.indexOf("{");
		e1 = raw1.lastIndexOf("}");
		if(s1 >= 0 && e1 > s1)
		{
			json1 = raw1.subString(s1,e1 + 1);
		}
	}
	catch (e_slice1)
	{
		json1 = raw1;
	}
	// Parse contact data
	contact_map = null;
	try 
	{
		contact_map = json1.toMap();
	}
	catch (e_parse1)
	{
		info "Failed to parse contact JSON for " + company_name_str + ": " + json1;
		continue;
	}
	// Get email pattern from API response
	email_pattern = null;
	if(contact_map.containsKey("email_pattern_hint"))
	{
		email_pattern = contact_map.get("email_pattern_hint");
	}
	// -----------------------------------------
	// HELPER FUNCTION: Generate email predictions from name + domain
	// Uses indexOf/subString only (NO split, NO replace)
	// -----------------------------------------
	// Process PRIMARY contact
	primary_contact = Map();
	primary_has_name = false;
	if(contact_map.containsKey("primary_stakeholder"))
	{
		ps = contact_map.get("primary_stakeholder");
		if(ps != null)
		{
			ps_name = ps.get("name");
			ps_email = ps.get("email");
			// Check if we have a valid name (not null, not empty, not "null" string)
			if(ps_name != null && (ps_name + "").trim() != "" && (ps_name + "").trim().toLowerCase() != "null")
			{
				primary_has_name = true;
				primary_contact.put("name",ps_name);
				primary_contact.put("job_title",ps.get("job_title"));
				primary_contact.put("company",ps.get("company"));
				primary_contact.put("phone",ps.get("phone"));
				primary_contact.put("location",ps.get("location"));
				primary_contact.put("linkedin_url",ps.get("linkedin_url"));
				primary_contact.put("company_website",ps.get("company_website"));
				primary_contact.put("source_url",ps.get("source_url"));
				primary_contact.put("notes",ps.get("notes"));
				// Handle email - if found use it, otherwise predict
				if(ps_email != null && (ps_email + "").trim() != "" && (ps_email + "").trim().toLowerCase() != "null")
				{
					primary_contact.put("email",ps_email);
					primary_contact.put("email_status","verified");
					primary_contact.put("email_confidence","high");
				}
				else
				{
					// Generate predicted emails from name
					full_name = (ps_name + "").trim().toLowerCase();
					first_name = "";
					last_name = "";
					// Extract first and last name using indexOf (NO split)
					space_pos = full_name.indexOf(" ");
					if(space_pos > 0)
					{
						first_name = full_name.subString(0,space_pos).trim();
						// Get last name (last word after final space)
						remaining = full_name.subString(space_pos + 1,full_name.length()).trim();
						last_space = remaining.lastIndexOf(" ");
						if(last_space > 0)
						{
							last_name = remaining.subString(last_space + 1,remaining.length()).trim();
						}
						else
						{
							last_name = remaining;
						}
					}
					else
					{
						first_name = full_name;
					}
					// Generate email permutations
					email_perms = List();
					if(first_name != "" && last_name != "")
					{
						// firstname.lastname@domain (most common UK pattern)
						email_perms.add(first_name + "." + last_name + "@" + domain);
						// firstname@domain
						email_perms.add(first_name + "@" + domain);
						// firstnamelastname@domain
						email_perms.add(first_name + last_name + "@" + domain);
						// f.lastname@domain
						first_initial = first_name.subString(0,1);
						email_perms.add(first_initial + "." + last_name + "@" + domain);
						// flastname@domain
						email_perms.add(first_initial + last_name + "@" + domain);
						// lastname.firstname@domain
						email_perms.add(last_name + "." + first_name + "@" + domain);
						// Set primary predicted email (firstname.lastname is most common)
						primary_contact.put("email",first_name + "." + last_name + "@" + domain);
						primary_contact.put("email_status","predicted");
						primary_contact.put("email_confidence","medium");
						primary_contact.put("email_permutations",email_perms);
						primary_contact.put("email_prediction_method","Generated from name + domain pattern");
					}
					else if(first_name != "")
					{
						email_perms.add(first_name + "@" + domain);
						primary_contact.put("email",first_name + "@" + domain);
						primary_contact.put("email_status","predicted");
						primary_contact.put("email_confidence","low");
						primary_contact.put("email_permutations",email_perms);
						primary_contact.put("email_prediction_method","Generated from first name only");
					}
					else
					{
						primary_contact.put("email",null);
						primary_contact.put("email_status","unknown");
						primary_contact.put("email_confidence","none");
					}
				}
			}
		}
	}
	// If primary contact is empty, add placeholder with company info
	if(primary_has_name == false)
	{
		primary_contact.put("name",null);
		primary_contact.put("job_title",target_job_title);
		primary_contact.put("company",company_name_str);
		primary_contact.put("email",null);
		primary_contact.put("email_status","not_found");
		primary_contact.put("phone",null);
		primary_contact.put("location",null);
		primary_contact.put("linkedin_url",null);
		primary_contact.put("company_website",website);
		primary_contact.put("source_url",null);
		primary_contact.put("notes","No " + target_job_title + " found for this company");
	}
	// Process SECONDARY contact (same logic)
	secondary_contact = Map();
	secondary_has_name = false;
	if(contact_map.containsKey("secondary_stakeholder"))
	{
		ss = contact_map.get("secondary_stakeholder");
		if(ss != null)
		{
			ss_name = ss.get("name");
			ss_email = ss.get("email");
			// Check if we have a valid name
			if(ss_name != null && (ss_name + "").trim() != "" && (ss_name + "").trim().toLowerCase() != "null")
			{
				secondary_has_name = true;
				secondary_contact.put("name",ss_name);
				secondary_contact.put("job_title",ss.get("job_title"));
				secondary_contact.put("company",ss.get("company"));
				secondary_contact.put("phone",ss.get("phone"));
				secondary_contact.put("location",ss.get("location"));
				secondary_contact.put("linkedin_url",ss.get("linkedin_url"));
				secondary_contact.put("company_website",ss.get("company_website"));
				secondary_contact.put("source_url",ss.get("source_url"));
				secondary_contact.put("notes",ss.get("notes"));
				// Handle email - if found use it, otherwise predict
				if(ss_email != null && (ss_email + "").trim() != "" && (ss_email + "").trim().toLowerCase() != "null")
				{
					secondary_contact.put("email",ss_email);
					secondary_contact.put("email_status","verified");
					secondary_contact.put("email_confidence","high");
				}
				else
				{
					// Generate predicted emails from name
					full_name_s = (ss_name + "").trim().toLowerCase();
					first_name_s = "";
					last_name_s = "";
					space_pos_s = full_name_s.indexOf(" ");
					if(space_pos_s > 0)
					{
						first_name_s = full_name_s.subString(0,space_pos_s).trim();
						remaining_s = full_name_s.subString(space_pos_s + 1,full_name_s.length()).trim();
						last_space_s = remaining_s.lastIndexOf(" ");
						if(last_space_s > 0)
						{
							last_name_s = remaining_s.subString(last_space_s + 1,remaining_s.length()).trim();
						}
						else
						{
							last_name_s = remaining_s;
						}
					}
					else
					{
						first_name_s = full_name_s;
					}
					email_perms_s = List();
					if(first_name_s != "" && last_name_s != "")
					{
						email_perms_s.add(first_name_s + "." + last_name_s + "@" + domain);
						email_perms_s.add(first_name_s + "@" + domain);
						email_perms_s.add(first_name_s + last_name_s + "@" + domain);
						first_initial_s = first_name_s.subString(0,1);
						email_perms_s.add(first_initial_s + "." + last_name_s + "@" + domain);
						email_perms_s.add(first_initial_s + last_name_s + "@" + domain);
						secondary_contact.put("email",first_name_s + "." + last_name_s + "@" + domain);
						secondary_contact.put("email_status","predicted");
						secondary_contact.put("email_confidence","medium");
						secondary_contact.put("email_permutations",email_perms_s);
						secondary_contact.put("email_prediction_method","Generated from name + domain pattern");
					}
					else if(first_name_s != "")
					{
						email_perms_s.add(first_name_s + "@" + domain);
						secondary_contact.put("email",first_name_s + "@" + domain);
						secondary_contact.put("email_status","predicted");
						secondary_contact.put("email_confidence","low");
						secondary_contact.put("email_permutations",email_perms_s);
					}
					else
					{
						secondary_contact.put("email",null);
						secondary_contact.put("email_status","unknown");
						secondary_contact.put("email_confidence","none");
					}
				}
			}
		}
	}
	// If secondary contact is empty, add placeholder
	if(secondary_has_name == false)
	{
		secondary_contact.put("name",null);
		secondary_contact.put("job_title",null);
		secondary_contact.put("company",company_name_str);
		secondary_contact.put("email",null);
		secondary_contact.put("email_status","not_found");
		secondary_contact.put("phone",null);
		secondary_contact.put("location",null);
		secondary_contact.put("linkedin_url",null);
		secondary_contact.put("company_website",website);
		secondary_contact.put("source_url",null);
		secondary_contact.put("notes","No secondary contact found");
	}
	// Build final contact map
	contacts_result = Map();
	contacts_result.put("primary_contact",primary_contact);
	contacts_result.put("secondary_contact",secondary_contact);
	contacts_result.put("email_pattern",email_pattern);
	if(contact_map.containsKey("email_examples"))
	{
		contacts_result.put("email_examples",contact_map.get("email_examples"));
	}
	if(contact_map.containsKey("email_pattern_source"))
	{
		contacts_result.put("email_pattern_source",contact_map.get("email_pattern_source"));
	}
	company_result = Map();
	company_result.put("company_name",company_name);
	company_result.put("company_website",website);
	company_result.put("company_domain",domain);
	company_result.put("discovered_sector",comp2.get("sector"));
	company_result.put("employee_size",comp2.get("employee_size"));
	company_result.put("location",comp2.get("location"));
	company_result.put("contacts",contacts_result);
	results.add(company_result);
	if(results.size() >= max_companies)
	{
		break;
	}
}
out.put("status","OK");
out.put("sector",requested_sector);
out.put("company_size",requested_size);
out.put("job_title",target_job_title);
out.put("result_count",results.size());
out.put("results",results);
info out;
}
}
